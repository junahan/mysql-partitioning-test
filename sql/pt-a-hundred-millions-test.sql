-- 1 亿规模数据测试
-- in_date 日期范围集中在 (20170101, 20171231)
show create table pt_a_hundred_millions_original\G;

-- 添加索引
-- ALTER TABLE pt_a_hundred_millions_original
--       ADD INDEX pt_ahmo_id (id),
-- 			ADD INDEX pt_ahmo_goods_id (goods_id),
-- 			ADD INDEX pt_ahmo_in_date (in_date);

-- 复制表
create table pt_a_hundred_millions_partitioning_test as (select * from pt_a_hundred_millions_original);

-- 表查找 in_date 范围
select max(in_date), min(in_date) from pt_a_hundred_millions_original;

-- 统计数据年度分布
select YEAR(in_date), count(1) from pt_a_hundred_millions_original group by YEAR(in_date);

-- 表统计数据月度分布
select MONTH(in_date), count(1) from pt_a_hundred_millions_original where YEAR(in_date) = '2017' group by MONTH(in_date);

-- 1	1,070,887
-- 2	913,882
-- 3	588,385
-- 4	17,696,784
-- 5	23,140,624
-- 6	19,158,649
-- 7	23,351,939
-- 8	5,861,501
-- 9	2,026,982
-- 10	1,945,546
-- 11	1,412,040
-- 12	132,724

-- 修改表以创建分区
ALTER TABLE pt_a_hundred_millions_partitioning_test PARTITION BY RANGE COLUMNS (in_date)
-- 2016 年及以前约 2 百万数据。
(PARTITION p20161201 VALUES LESS THAN ('2016-12-01') ENGINE = InnoDB,
 -- 1 月约百万数据
 PARTITION p20170101 VALUES LESS THAN ('2017-01-01') ENGINE = InnoDB,
 PARTITION p20170115 VALUES LESS THAN ('2017-01-15') ENGINE = InnoDB,
 -- 2 月约百万级别
 PARTITION p20170201 VALUES LESS THAN ('2017-02-01') ENGINE = InnoDB,
 PARTITION p20170215 VALUES LESS THAN ('2017-02-15') ENGINE = InnoDB,
 -- 3 月约百万级别
 PARTITION p20170301 VALUES LESS THAN ('2017-03-01') ENGINE = InnoDB,
 PARTITION p20170315 VALUES LESS THAN ('2017-03-15') ENGINE = InnoDB,
 -- 4 月约 2 千万级别
 PARTITION p20170401 VALUES LESS THAN ('2017-04-01') ENGINE = InnoDB,
 PARTITION p20170402 VALUES LESS THAN ('2017-04-02') ENGINE = InnoDB,
 PARTITION p20170403 VALUES LESS THAN ('2017-04-03') ENGINE = InnoDB,
 PARTITION p20170404 VALUES LESS THAN ('2017-04-04') ENGINE = InnoDB,
 PARTITION p20170405 VALUES LESS THAN ('2017-04-05') ENGINE = InnoDB,
 PARTITION p20170406 VALUES LESS THAN ('2017-04-06') ENGINE = InnoDB,
 PARTITION p20170407 VALUES LESS THAN ('2017-04-07') ENGINE = InnoDB,
 PARTITION p20170408 VALUES LESS THAN ('2017-04-08') ENGINE = InnoDB,
 PARTITION p20170409 VALUES LESS THAN ('2017-04-09') ENGINE = InnoDB,
 PARTITION p20170410 VALUES LESS THAN ('2017-04-10') ENGINE = InnoDB,
 PARTITION p20170411 VALUES LESS THAN ('2017-04-11') ENGINE = InnoDB,
 PARTITION p20170412 VALUES LESS THAN ('2017-04-12') ENGINE = InnoDB,
 PARTITION p20170413 VALUES LESS THAN ('2017-04-13') ENGINE = InnoDB,
 PARTITION p20170414 VALUES LESS THAN ('2017-04-14') ENGINE = InnoDB,
 PARTITION p20170415 VALUES LESS THAN ('2017-04-15') ENGINE = InnoDB,
 PARTITION p20170416 VALUES LESS THAN ('2017-04-16') ENGINE = InnoDB,
 PARTITION p20170417 VALUES LESS THAN ('2017-04-17') ENGINE = InnoDB,
 PARTITION p20170418 VALUES LESS THAN ('2017-04-18') ENGINE = InnoDB,
 PARTITION p20170419 VALUES LESS THAN ('2017-04-19') ENGINE = InnoDB,
 PARTITION p20170420 VALUES LESS THAN ('2017-04-20') ENGINE = InnoDB,
 PARTITION p20170421 VALUES LESS THAN ('2017-04-21') ENGINE = InnoDB,
 PARTITION p20170422 VALUES LESS THAN ('2017-04-22') ENGINE = InnoDB,
 PARTITION p20170423 VALUES LESS THAN ('2017-04-23') ENGINE = InnoDB,
 PARTITION p20170424 VALUES LESS THAN ('2017-04-24') ENGINE = InnoDB,
 PARTITION p20170425 VALUES LESS THAN ('2017-04-25') ENGINE = InnoDB,
 PARTITION p20170426 VALUES LESS THAN ('2017-04-26') ENGINE = InnoDB,
 PARTITION p20170427 VALUES LESS THAN ('2017-04-27') ENGINE = InnoDB,
 PARTITION p20170428 VALUES LESS THAN ('2017-04-28') ENGINE = InnoDB,
 PARTITION p20170429 VALUES LESS THAN ('2017-04-29') ENGINE = InnoDB,
 PARTITION p20170430 VALUES LESS THAN ('2017-04-30') ENGINE = InnoDB,
 -- 5 月约 2 千万级别
 PARTITION p20170501 VALUES LESS THAN ('2017-05-01') ENGINE = InnoDB,
 PARTITION p20170502 VALUES LESS THAN ('2017-05-02') ENGINE = InnoDB,
 PARTITION p20170503 VALUES LESS THAN ('2017-05-03') ENGINE = InnoDB,
 PARTITION p20170504 VALUES LESS THAN ('2017-05-04') ENGINE = InnoDB,
 PARTITION p20170505 VALUES LESS THAN ('2017-05-05') ENGINE = InnoDB,
 PARTITION p20170506 VALUES LESS THAN ('2017-05-06') ENGINE = InnoDB,
 PARTITION p20170507 VALUES LESS THAN ('2017-05-07') ENGINE = InnoDB,
 PARTITION p20170508 VALUES LESS THAN ('2017-05-08') ENGINE = InnoDB,
 PARTITION p20170509 VALUES LESS THAN ('2017-05-09') ENGINE = InnoDB,
 PARTITION p20170510 VALUES LESS THAN ('2017-05-10') ENGINE = InnoDB,
 PARTITION p20170511 VALUES LESS THAN ('2017-05-11') ENGINE = InnoDB,
 PARTITION p20170512 VALUES LESS THAN ('2017-05-12') ENGINE = InnoDB,
 PARTITION p20170513 VALUES LESS THAN ('2017-05-13') ENGINE = InnoDB,
 PARTITION p20170514 VALUES LESS THAN ('2017-05-14') ENGINE = InnoDB,
 PARTITION p20170515 VALUES LESS THAN ('2017-05-15') ENGINE = InnoDB,
 PARTITION p20170516 VALUES LESS THAN ('2017-05-16') ENGINE = InnoDB,
 PARTITION p20170517 VALUES LESS THAN ('2017-05-17') ENGINE = InnoDB,
 PARTITION p20170518 VALUES LESS THAN ('2017-05-18') ENGINE = InnoDB,
 PARTITION p20170519 VALUES LESS THAN ('2017-05-19') ENGINE = InnoDB,
 PARTITION p20170520 VALUES LESS THAN ('2017-05-20') ENGINE = InnoDB,
 PARTITION p20170521 VALUES LESS THAN ('2017-05-21') ENGINE = InnoDB,
 PARTITION p20170522 VALUES LESS THAN ('2017-05-22') ENGINE = InnoDB,
 PARTITION p20170523 VALUES LESS THAN ('2017-05-23') ENGINE = InnoDB,
 PARTITION p20170524 VALUES LESS THAN ('2017-05-24') ENGINE = InnoDB,
 PARTITION p20170525 VALUES LESS THAN ('2017-05-25') ENGINE = InnoDB,
 PARTITION p20170526 VALUES LESS THAN ('2017-05-26') ENGINE = InnoDB,
 PARTITION p20170527 VALUES LESS THAN ('2017-05-27') ENGINE = InnoDB,
 PARTITION p20170528 VALUES LESS THAN ('2017-05-28') ENGINE = InnoDB,
 PARTITION p20170529 VALUES LESS THAN ('2017-05-29') ENGINE = InnoDB,
 PARTITION p20170530 VALUES LESS THAN ('2017-05-30') ENGINE = InnoDB,
 -- 6 月约 2 千万级别
 PARTITION p20170601 VALUES LESS THAN ('2017-06-01') ENGINE = InnoDB,
 PARTITION p20170602 VALUES LESS THAN ('2017-06-02') ENGINE = InnoDB,
 PARTITION p20170603 VALUES LESS THAN ('2017-06-03') ENGINE = InnoDB,
 PARTITION p20170604 VALUES LESS THAN ('2017-06-04') ENGINE = InnoDB,
 PARTITION p20170605 VALUES LESS THAN ('2017-06-05') ENGINE = InnoDB,
 PARTITION p20170606 VALUES LESS THAN ('2017-06-06') ENGINE = InnoDB,
 PARTITION p20170607 VALUES LESS THAN ('2017-06-07') ENGINE = InnoDB,
 PARTITION p20170608 VALUES LESS THAN ('2017-06-08') ENGINE = InnoDB,
 PARTITION p20170609 VALUES LESS THAN ('2017-06-09') ENGINE = InnoDB,
 PARTITION p20170610 VALUES LESS THAN ('2017-06-10') ENGINE = InnoDB,
 PARTITION p20170611 VALUES LESS THAN ('2017-06-11') ENGINE = InnoDB,
 PARTITION p20170612 VALUES LESS THAN ('2017-06-12') ENGINE = InnoDB,
 PARTITION p20170613 VALUES LESS THAN ('2017-06-13') ENGINE = InnoDB,
 PARTITION p20170614 VALUES LESS THAN ('2017-06-14') ENGINE = InnoDB,
 PARTITION p20170615 VALUES LESS THAN ('2017-06-15') ENGINE = InnoDB,
 PARTITION p20170616 VALUES LESS THAN ('2017-06-16') ENGINE = InnoDB,
 PARTITION p20170617 VALUES LESS THAN ('2017-06-17') ENGINE = InnoDB,
 PARTITION p20170618 VALUES LESS THAN ('2017-06-18') ENGINE = InnoDB,
 PARTITION p20170619 VALUES LESS THAN ('2017-06-19') ENGINE = InnoDB,
 PARTITION p20170620 VALUES LESS THAN ('2017-06-20') ENGINE = InnoDB,
 PARTITION p20170621 VALUES LESS THAN ('2017-06-21') ENGINE = InnoDB,
 PARTITION p20170622 VALUES LESS THAN ('2017-06-22') ENGINE = InnoDB,
 PARTITION p20170623 VALUES LESS THAN ('2017-06-23') ENGINE = InnoDB,
 PARTITION p20170624 VALUES LESS THAN ('2017-06-24') ENGINE = InnoDB,
 PARTITION p20170625 VALUES LESS THAN ('2017-06-25') ENGINE = InnoDB,
 PARTITION p20170626 VALUES LESS THAN ('2017-06-26') ENGINE = InnoDB,
 PARTITION p20170627 VALUES LESS THAN ('2017-06-27') ENGINE = InnoDB,
 PARTITION p20170628 VALUES LESS THAN ('2017-06-28') ENGINE = InnoDB,
 PARTITION p20170629 VALUES LESS THAN ('2017-06-29') ENGINE = InnoDB,
 PARTITION p20170630 VALUES LESS THAN ('2017-06-30') ENGINE = InnoDB,
 -- 7 月约 2 千万级别
 PARTITION p20170701 VALUES LESS THAN ('2017-07-01') ENGINE = InnoDB,
 PARTITION p20170702 VALUES LESS THAN ('2017-07-02') ENGINE = InnoDB,
 PARTITION p20170703 VALUES LESS THAN ('2017-07-03') ENGINE = InnoDB,
 PARTITION p20170704 VALUES LESS THAN ('2017-07-04') ENGINE = InnoDB,
 PARTITION p20170705 VALUES LESS THAN ('2017-07-05') ENGINE = InnoDB,
 PARTITION p20170706 VALUES LESS THAN ('2017-07-06') ENGINE = InnoDB,
 PARTITION p20170707 VALUES LESS THAN ('2017-07-07') ENGINE = InnoDB,
 PARTITION p20170708 VALUES LESS THAN ('2017-07-08') ENGINE = InnoDB,
 PARTITION p20170709 VALUES LESS THAN ('2017-07-09') ENGINE = InnoDB,
 PARTITION p20170710 VALUES LESS THAN ('2017-07-10') ENGINE = InnoDB,
 PARTITION p20170711 VALUES LESS THAN ('2017-07-11') ENGINE = InnoDB,
 PARTITION p20170712 VALUES LESS THAN ('2017-07-12') ENGINE = InnoDB,
 PARTITION p20170713 VALUES LESS THAN ('2017-07-13') ENGINE = InnoDB,
 PARTITION p20170714 VALUES LESS THAN ('2017-07-14') ENGINE = InnoDB,
 PARTITION p20170715 VALUES LESS THAN ('2017-07-15') ENGINE = InnoDB,
 PARTITION p20170716 VALUES LESS THAN ('2017-07-16') ENGINE = InnoDB,
 PARTITION p20170717 VALUES LESS THAN ('2017-07-17') ENGINE = InnoDB,
 PARTITION p20170718 VALUES LESS THAN ('2017-07-18') ENGINE = InnoDB,
 PARTITION p20170719 VALUES LESS THAN ('2017-07-19') ENGINE = InnoDB,
 PARTITION p20170720 VALUES LESS THAN ('2017-07-20') ENGINE = InnoDB,
 PARTITION p20170721 VALUES LESS THAN ('2017-07-21') ENGINE = InnoDB,
 PARTITION p20170722 VALUES LESS THAN ('2017-07-22') ENGINE = InnoDB,
 PARTITION p20170723 VALUES LESS THAN ('2017-07-23') ENGINE = InnoDB,
 PARTITION p20170724 VALUES LESS THAN ('2017-07-24') ENGINE = InnoDB,
 PARTITION p20170725 VALUES LESS THAN ('2017-07-25') ENGINE = InnoDB,
 PARTITION p20170726 VALUES LESS THAN ('2017-07-26') ENGINE = InnoDB,
 PARTITION p20170727 VALUES LESS THAN ('2017-07-27') ENGINE = InnoDB,
 PARTITION p20170728 VALUES LESS THAN ('2017-07-28') ENGINE = InnoDB,
 PARTITION p20170729 VALUES LESS THAN ('2017-07-29') ENGINE = InnoDB,
 PARTITION p20170730 VALUES LESS THAN ('2017-07-30') ENGINE = InnoDB,
 -- 8 月约 5 百万级别
 PARTITION p20170801 VALUES LESS THAN ('2017-08-01') ENGINE = InnoDB,
 PARTITION p20170804 VALUES LESS THAN ('2017-08-04') ENGINE = InnoDB,
 PARTITION p20170807 VALUES LESS THAN ('2017-08-07') ENGINE = InnoDB,
 PARTITION p20170810 VALUES LESS THAN ('2017-08-10') ENGINE = InnoDB,
 PARTITION p20170813 VALUES LESS THAN ('2017-08-13') ENGINE = InnoDB,
 PARTITION p20170816 VALUES LESS THAN ('2017-08-16') ENGINE = InnoDB,
 PARTITION p20170819 VALUES LESS THAN ('2017-08-19') ENGINE = InnoDB,
 PARTITION p20170822 VALUES LESS THAN ('2017-08-22') ENGINE = InnoDB,
 PARTITION p20170825 VALUES LESS THAN ('2017-08-25') ENGINE = InnoDB,
 PARTITION p20170828 VALUES LESS THAN ('2017-08-28') ENGINE = InnoDB,
 -- 9 月约 2 百万级别
 PARTITION p20170901 VALUES LESS THAN ('2017-09-01') ENGINE = InnoDB,
 PARTITION p20170908 VALUES LESS THAN ('2017-09-08') ENGINE = InnoDB,
 PARTITION p20170915 VALUES LESS THAN ('2017-09-15') ENGINE = InnoDB,
 PARTITION p20170922 VALUES LESS THAN ('2017-09-22') ENGINE = InnoDB,
 -- 10 月约 2 百万级别
 PARTITION p20171001 VALUES LESS THAN ('2017-10-01') ENGINE = InnoDB,
 PARTITION p20171008 VALUES LESS THAN ('2017-10-08') ENGINE = InnoDB,
 PARTITION p20171015 VALUES LESS THAN ('2017-10-15') ENGINE = InnoDB,
 PARTITION p20171022 VALUES LESS THAN ('2017-10-22') ENGINE = InnoDB,
 -- 11 月约百万级别
 PARTITION p20171101 VALUES LESS THAN ('2017-11-01') ENGINE = InnoDB,
 PARTITION p20171115 VALUES LESS THAN ('2017-11-15') ENGINE = InnoDB,
 -- 12 月约百万级别
 PARTITION p20171201 VALUES LESS THAN ('2017-12-01') ENGINE = InnoDB,
 PARTITION p20171215 VALUES LESS THAN ('2017-12-15') ENGINE = InnoDB,
 PARTITION p20180101 VALUES LESS THAN ('2018-01-01') ENGINE = InnoDB,
 -- 2017 年以后约百万数据
 PARTITION p20999999 VALUES LESS THAN MAXVALUE ENGINE = InnoDB);

-- 添加索引
ALTER TABLE pt_a_hundred_millions_partitioning_test
      ADD INDEX pt_ahmpt_id (id),
			ADD INDEX pt_ahmpt_goods_id (goods_id),
			ADD INDEX pt_ahmpt_in_date (in_date);

-- 查看分区表结构
show create table pt_a_hundred_millions_partitioning_test\G;

-- CASE - insert
-- 从 2017-01-01 开始随机增加天数.
-- select DATE_ADD('2017-01-01', INTERVAL FLOOR(1 + (RAND() * 99)) DAY);

-- 创建存储过程 - original
DELIMITER ;;
DROP PROCEDURE  IF EXISTS insert_pt_a_hundred_millions_original;
CREATE PROCEDURE insert_pt_a_hundred_millions_original ()
BEGIN
DECLARE i INT DEFAULT 1;

WHILE i<100
DO
insert into pt_a_hundred_millions_original values (UNIX_TIMESTAMP(), UNIX_TIMESTAMP(),'test', DATE_ADD('2017-01-01', INTERVAL FLOOR(1 + (RAND() * 99)) DAY));
SET i=i+1;
END WHILE;

commit;
END;;

-- 调用存储过程 - original
call insert_pt_a_hundred_millions_original;

-- 创建存储过程 - partition table
DELIMITER ;;
DROP PROCEDURE  IF EXISTS insert_pt_a_hundred_millions_partition;
CREATE PROCEDURE insert_pt_a_hundred_millions_partition ()
BEGIN
DECLARE i INT DEFAULT 1;

WHILE i<100
DO
insert into pt_a_hundred_millions_partitioning_test values (UNIX_TIMESTAMP(), UNIX_TIMESTAMP(),'test', DATE_ADD('2017-01-01', INTERVAL FLOOR(1 + (RAND() * 99)) DAY));
SET i=i+1;
END WHILE;

commit;
END;;

-- 调用存储过程 - partition table
call insert_pt_a_hundred_millions_partition;

-- CASE - 选择约 100 万数据
explain
select count(goods_name) from pt_a_hundred_millions_original where in_date > '2017-02-01' and in_date < '2017-03-5';

explain
select count(goods_name) from pt_a_hundred_millions_partitioning_test where in_date > '2017-02-01' and in_date < '2017-03-5';

-- CASE - 选择约 200 万数据
explain
select count(goods_name) from pt_a_hundred_millions_original where in_date > '2017-02-01' and in_date < '2017-04-7';

explain
select count(goods_name) from pt_a_hundred_millions_partitioning_test where in_date > '2017-02-01' and in_date < '2017-04-7';

-- 选择约 500 万数据
explain
select count(goods_name) from pt_a_hundred_millions_original where in_date > '2017-02-01' and in_date < '2017-04-12';

explain
select count(goods_name) from pt_a_hundred_millions_partitioning_test where in_date > '2017-02-01' and in_date < '2017-04-12';

-- CASE - 带 where 子句的 join 查询 - 选择 100 万数据
explain
select count(t1.goods_name) from pt_a_hundred_millions_original as t1
	left join pt_base_goods as base
	on t1.goods_id = base.goods_id
	where in_date > '2017-02-01' and in_date < '2017-03-5';

explain
select count(t1.goods_name) from pt_a_hundred_millions_partitioning_test as t1
	left join pt_base_goods as base
	on t1.goods_id = base.goods_id
	where in_date > '2017-02-01' and in_date < '2017-03-5';

-- CASE - 全表扫描对比
explain
select count(goods_name) from pt_a_hundred_millions_original;

explain
select count(goods_name) from pt_a_hundred_millions_partitioning_test;
